// Code generated by hiro; DO NOT EDIT.

// Copyright 2018 Portworx Inc. All rights reserved.
// Use of this source code is governed by the Apache 2.0
// license that can be found in the LICENSE file at the
// root of this project.

package rest

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"

	"github.com/dre1080/recover"
	"github.com/go-openapi/errors"
	"github.com/go-openapi/loads"
	"github.com/go-openapi/runtime"
	"github.com/go-openapi/runtime/middleware"
	"github.com/sirupsen/logrus"

	interpose "github.com/carbocation/interpose/middleware"
	sparks "gitlab.com/ModelRocket/sparks/types"

	"github.com/libopenstorage/autopilot/api/autopilot"
	"github.com/libopenstorage/autopilot/api/autopilot/rest/operations"
	"github.com/libopenstorage/autopilot/api/autopilot/rest/operations/collector"
	"github.com/libopenstorage/autopilot/api/autopilot/rest/operations/emitter"
	"github.com/libopenstorage/autopilot/api/autopilot/rest/operations/rule"
	"github.com/libopenstorage/autopilot/api/autopilot/rest/operations/sample"
	"github.com/libopenstorage/autopilot/api/autopilot/rest/operations/task"
)

type contextKey string

const AuthKey contextKey = "Auth"

// CollectorAPI
type CollectorAPI interface {
	// CollectorList is Returns an array of telemetry collectors defined in the system
	CollectorList(ctx *autopilot.Context, params collector.CollectorListParams) middleware.Responder
	// CollectorPoll is Polls a collector for the current data period
	CollectorPoll(ctx *autopilot.Context, params collector.CollectorPollParams) middleware.Responder
}

// EmitterAPI
type EmitterAPI interface {
	// EmitterList is Returns an array of telemetry emitters defined in the system
	EmitterList(ctx *autopilot.Context, params emitter.EmitterListParams) middleware.Responder
}

// OperationsAPI
type OperationsAPI interface {
	// RecommendationsGet is Create a new telemetry sample from the provided definition and get recommendations
	RecommendationsGet(ctx *autopilot.Context, params operations.RecommendationsGetParams) middleware.Responder
}

// RuleAPI
type RuleAPI interface {
	// RuleList is Returns an array of telemetry rules defined in the system
	RuleList(ctx *autopilot.Context, params rule.RuleListParams) middleware.Responder
}

// SampleAPI
type SampleAPI interface {
	// SampleDelete is Delete a sample from the disk
	SampleDelete(ctx *autopilot.Context, params sample.SampleDeleteParams) middleware.Responder
	// SampleList is Returns an array of samples
	SampleList(ctx *autopilot.Context, params sample.SampleListParams) middleware.Responder
}

// TaskAPI
type TaskAPI interface {
	// TaskList is Returns an array of tasks
	TaskList(ctx *autopilot.Context, params task.TaskListParams) middleware.Responder
}

type AutopilotAPI interface {
	CollectorAPI
	EmitterAPI
	OperationsAPI
	RuleAPI
	SampleAPI
	TaskAPI
	// Initialize is called during handler creation to perform and changes during startup
	Initialize() error

	// InitializeContext is call before the api methods are executed
	InitializeContext(principal interface{}, r *http.Request) (*autopilot.Context, error)
}

// Config is configuration for Handler
type Config struct {
	AutopilotAPI
	Logger *logrus.Logger
	// InnerMiddleware is for the handler executors. These do not apply to the swagger.json document.
	// The middleware executes after routing but before authentication, binding and validation
	InnerMiddleware func(http.Handler) http.Handler

	// AuthBasicAuth for basic authentication
	AuthBasicAuth func(ctx context.Context, user string, pass string) (context.Context, interface{}, error)
}

// Handler returns an http.Handler given the handler configuration
// It mounts all the business logic implementers in the right routing.
func Handler(c Config) (http.Handler, error) {
	spec, err := loads.Analyzed(swaggerCopy(SwaggerJSON), "")
	if err != nil {
		return nil, fmt.Errorf("analyze swagger: %v", err)
	}
	api := operations.NewAutopilotAPI(spec)
	api.ServeError = errors.ServeError
	api.Logger = c.Logger.Printf

	api.JSONConsumer = runtime.JSONConsumer()
	api.MultipartformConsumer = runtime.DiscardConsumer
	api.JSONProducer = runtime.JSONProducer()
	api.BasicAuthAuth = func(ctx context.Context, user string, pass string) (context.Context, interface{}, error) {
		if c.AuthBasicAuth == nil {
			return ctx, nil, sparks.ErrNotAuthorized
		}
		return c.AuthBasicAuth(ctx, user, pass)
	}

	api.CollectorCollectorListHandler = collector.CollectorListHandlerFunc(func(params collector.CollectorListParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.CollectorList(ctx, params)
	})
	api.CollectorCollectorPollHandler = collector.CollectorPollHandlerFunc(func(params collector.CollectorPollParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.CollectorPoll(ctx, params)
	})
	api.EmitterEmitterListHandler = emitter.EmitterListHandlerFunc(func(params emitter.EmitterListParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.EmitterList(ctx, params)
	})
	api.RecommendationsGetHandler = operations.RecommendationsGetHandlerFunc(func(params operations.RecommendationsGetParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.RecommendationsGet(ctx, params)
	})
	api.RuleRuleListHandler = rule.RuleListHandlerFunc(func(params rule.RuleListParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.RuleList(ctx, params)
	})
	api.SampleSampleDeleteHandler = sample.SampleDeleteHandlerFunc(func(params sample.SampleDeleteParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.SampleDelete(ctx, params)
	})
	api.SampleSampleListHandler = sample.SampleListHandlerFunc(func(params sample.SampleListParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.SampleList(ctx, params)
	})
	api.TaskTaskListHandler = task.TaskListHandlerFunc(func(params task.TaskListParams, principal interface{}) middleware.Responder {
		ctx, err := c.InitializeContext(principal, params.HTTPRequest)
		if err != nil {
			return sparks.NewError(err)
		}
		return c.AutopilotAPI.TaskList(ctx, params)
	})
	api.ServerShutdown = func() {}

	logMiddleware := func(handler http.Handler) http.Handler {
		handlePanic := recover.New(&recover.Options{
			Log: c.Logger.Error,
		})

		logViaLogrus := interpose.NegroniLogrus()

		if c.InnerMiddleware != nil {
			handler = c.InnerMiddleware(handler)
		}

		return handlePanic(logViaLogrus(handler))
	}

	if err := c.AutopilotAPI.Initialize(); err != nil {
		return nil, err
	}

	return api.Serve(logMiddleware), nil
}

// swaggerCopy copies the swagger json to prevent data races in runtime
func swaggerCopy(orig json.RawMessage) json.RawMessage {
	c := make(json.RawMessage, len(orig))
	copy(c, orig)
	return c
}
